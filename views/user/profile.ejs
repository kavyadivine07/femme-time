<%- include("../../views/partials/user/header") %>
<style>
 .card-green {
   background-color: #ADD8E6;
 }
 .main {
   padding: 30px 0;
 }
 .dashboard-menu {
   background-color: #cce3e6;
   border-radius: 10px;
   padding: 15px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 }
 .dashboard-menu .nav-link {
   font-weight: bold;
   color: #30683c;
   box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
   transition: box-shadow 0.3s ease;
 }
 .dashboard-menu .nav-link:hover {
   color: #00bfff;
   box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
 }
 .card {
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
   margin-bottom: 20px;
 }
 .card-header {
   background-color: #487379;
   color: white;
   border-radius: 10px 10px 0 0;
 }
 .btn-success {
   background-color: #577194;
   border-color: #6bb87d;
 }
 .btn-success:hover {
   background-color: #506955;
 }
 .form-group {
   margin-bottom: 15px;
 }
 .required {
   color: red;
 }
 @media (max-width: 768px) {
   .dashboard-menu {
     padding: 10px;
   }
   .card {
     margin-bottom: 15px;
   }
 }
 .page-header.breadcrumb-wrap {
   background-color: #eee2e9;
   padding: 15px 0;
 }
 .breadcrumb {
   display: flex;
   align-items: center;
   font-family: 'Arial', sans-serif;
   font-size: 16px;
   color: #121311;
 }
 .breadcrumb a {
   color: #007bff;
   text-decoration: none;
   position: relative;
   margin: 0 5px;
 }
 .breadcrumb a:hover {
   color: #0056b3;
 }
 .breadcrumb span {
   margin: 0 5px;
   color: #999;
 }
 .breadcrumb a::after {
   content: '';
   position: absolute;
   width: 100%;
   height: 2px;
   background: #6e6e3a;
   left: 0;
   bottom: -2px;
   transform: scaleX(0);
   transition: transform 0.3s ease;
 }
 .breadcrumb a:hover::after {
   transform: scaleX(1);
 }
</style>

<main class="main">
 <div class="page-header breadcrumb-wrap mb-3">
   <div class="container">
     <div class="breadcrumb">
       <a href="#" rel="nofollow">Home</a>
       <span></span> Profile <span></span> Account
     </div>
   </div>
 </div>
  <section class="pt-10 pb-10">
   <div class="container">
     <div class="row">
       <div class="col-lg-10 m-auto">
         <div class="row">
           <div class="col-md-4">
             <div class="dashboard-menu">
               <ul class="nav flex-column" role="tablist">
                 <li class="nav-item">
                   <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                     <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">
                     <i class="fi-rs-marker mr-10"></i>My Address
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                     <i class="fi-rs-shopping-bag mr-10"></i>Orders
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" href="/logout">
                     <i class="fi-rs-sign-out mr-10"></i>Logout
                   </a>
                 </li>
               </ul>
             </div>
           </div>
           <div class="col-md-8">
             <div class="tab-content dashboard-content">
               <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                 <div class="card card-green">
                   <div class="card-header">
                     <h5 class="mb-0 text-center">User Profile</h5>
                   </div>
                   <div class="card-body text-center">
                     <h5 class="card-title"><%= user.name %></h5>
                     <p class="card-text">
                       <strong>Phone:</strong> <%= user.phone %>
                     </p>
                     <p class="card-text">
                       <strong>Email:</strong> <%= user.email %>
                     </p>
                     <a href="/change-email" class="btn btn-sm btn-success ml-2">Change Email</a>
                     <a href="/change-password" class="btn btn-sm btn-success">Change Password</a>
                   </div>
                 </div>
               </div>

               <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                 <div class="row">
                   <% if (userAddress) { %>
                     <% userAddress.address.forEach((address) => { %>
                       <div class="col-lg-6">
                         <div class="card mb-3 mb-lg-0">
                           <div class="card-header">
                             <h5 class="mb-0"><%= address.addressType %></h5>
                           </div>
                           <div class="card-body">
                             <address>
                               <%= address.name %><br/>
                               <%= address.city %><br/>
                               <%= address.landMark %><br/>
                               <%= address.state %><br/>
                             </address>
                             <p><%= address.pincode %></p>
                             <p><%= address.phone %></p>
                             <p><%= address.altPhone %></p>
                             <div class="d-flex justify-content-between">
                               <a href="/editAddress?id=<%= address._id %>" class="btn-small">Edit</a>
                               <a href="/deleteAddress?id=<%= address._id %>" class="btn-small" onclick="return confirm('Are you sure you want to delete this address')">Delete</a>
                             </div>
                           </div>
                         </div>
                       </div>
                     <% }) %>
                   <% } else { %>
                     <div class="col-lg-6">
                       <div class="card mb-3 mb-lg-0">
                         <div class="card-header">
                           <h5 class="mb-0"></h5>
                         </div>
                         <div class="card-body">
                           <address>No address</address>
                         </div>
                       </div>
                     </div>
                   <% } %>
                   <div>
                     <a href="/addAddress">
                       <button class="btn btn-primary w-70">
                         Add address
                       </button>
                     </a>
                   </div>
                 </div>
               </div>

               <!-- orders tab -->
               <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Your Orders</h5>
                   </div>
                   <div class="card-body">
                     <div class="table-responsive">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>ID</th>
                             <th>Date</th>
                             <th>Status</th>
                             <th>Total</th>
                             <th>Payment</th>
                             <th>Actions</th>
                           </tr>
                         </thead>
                         <tbody>
                           <% if (typeof orders !== 'undefined' && orders && orders.length > 0) { %>
                             <% orders.forEach(order => { %>
                               <tr>
                                 <td class="order-id-cell"><%= order.orderId || order._id %></td>
                                 <td class="date-cell"><%= new Date(order.createdOn).toLocaleDateString() %></td>
                                 <td>
                                   <span class="status-badge <%= order.status.toLowerCase() === 'pending' ? 'status-pending' : order.status.toLowerCase() === 'delivered' ? 'status-delivered' : 'status-cancelled' %>">
                                     <%= order.status %>
                                   </span>
                                 </td>
                                 <td>
                                   <span class="amount-text"><%= order.finalAmount ? order.finalAmount.toFixed(2) : '0.00' %></span>
                                 </td>
                                 <td>
                                   <span class="status-badge <%= order.paymentStatus.toLowerCase() === 'pending' ? 'status-pending' : order.paymentStatus.toLowerCase() === 'paid' ? 'status-delivered' : 'status-cancelled' %>">
                                     <%= order.paymentStatus %>
                                   </span>
                                 </td>
                                 <td class="actions-cell">
                                   <div class="d-flex flex-column">
                                     <form action="/orders/view/<%= order.orderId %>" method="GET" class="mb-1">
                                       <button type="submit" class="btn btn-action btn-view">View</button>
                                     </form>
                                     <% if (order.status === 'Pending') { %>
                                       <button type="button" class="btn btn-action btn-cancel" onclick="cancelOrder('<%= order._id %>')">
                                         Cancel
                                       </button>
                                     <% } %>
                                     <% if (order.status === 'Delivered') { %>
                                       <button type="button" class="btn btn-action btn-return" onclick="redirectToReturnReason('<%= order._id %>')">
                                         Return
                                       </button>
                                     <% } %>
                                     <% if (order.paymentStatus === 'Pending') { %>
                                       <button type="button" class="btn btn-action btn-retry" onclick="retryPayment('<%= order._id %>')">
                                         Retry
                                       </button>
                                     <% } %>
                                   </div>
                                 </td>
                               </tr>
                             <% }); %>
                           <% } else { %>
                             <tr>
                               <td colspan="6" class="empty-state">
                                 <i class="fas fa-shopping-bag"></i>
                                 <p>No orders found.</p>
                               </td>
                             </tr>
                           <% } %>
                         </tbody>
                       </table>
                     </div>
                   </div>
                 </div>
               </div>

               <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Wallet</h5>
                   </div>
                   <div class="card-body contact-from-area">
                     <div class="row">
                       <div class="col-lg-8 mx-auto text-center mt-90">
                         <form>
                           <div class="form-group">
                             <label for="walletAmount" class="h4">Amount</label>
                             <div class="h3"></div>
                           </div>
                           <button type="button" class="btn btn-success" onclick="">Add Money</button>
                         </form>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>

               <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Wallet History</h5>
                   </div>
                   <div class="card-body">
                     <div class="table-responsive">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>Date</th>
                             <th>Status</th>
                             <th>Amount</th>
                           </tr>
                         </thead>
                         <tbody>
                           <tr>
                             <td></td>
                             <td></td>
                             <td></td>
                           </tr>
                         </tbody>
                       </table>
                     </div>
                   </div>
                 </div>
               </div>

               <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Referral</h5>
                   </div>
                   <div class="card-body">
                     <h6 class="mb-3">Refer your friends and earn money!</h6>
                     <p>Share this link: <strong></strong></p>
                     <p>Earned: â‚¹</p>
                   </div>
                 </div>
               </div>
             </div>
           </div>
         </div>
         <!-- Pagination -->
         <nav aria-label="Orders pagination" class="mt-3">
           <ul class="pagination">
             <% if (typeof currentPage !== 'undefined' && typeof totalPages !== 'undefined') { %>
               <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                 <a class="page-link" href="?page=<%= currentPage - 1 %>" <%= currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                   <i class="fas fa-chevron-left"></i>
                 </a>
               </li>
               <% for(let i = 1; i <= totalPages; i++) { %>
                 <% if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) { %>
                   <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                     <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                   </li>
                 <% } else if (i === currentPage - 2 || i === currentPage + 2) { %>
                   <li class="page-item disabled">
                     <span class="page-link">...</span>
                   </li>
                 <% } %>
               <% } %>
               <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                 <a class="page-link" href="?page=<%= currentPage + 1 %>" <%= currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                   <i class="fas fa-chevron-right"></i>
                 </a>
               </li>
             <% } %>
           </ul>
         </nav>
       </div>
     </div>
   </section>

   <!-- Cancel Order Modal -->
   <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
     <div class="modal-dialog">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body">
           <form id="cancelOrderForm">
             <input type="hidden" id="orderIdInput" name="orderId">
             <div class="mb-3">
               <label for="cancelReason" class="form-label">Reason for Cancellation</label>
               <select class="form-select" id="cancelReason" name="cancelReason">
                 <option value="">Select a reason</option>
                 <option value="Changed my mind">Changed my mind</option>
                 <option value="Found a better price">Found a better price</option>
                 <option value="Ordered by mistake">Ordered by mistake</option>
                 <option value="Other">Other</option>
               </select>
             </div>
             <div class="mb-3" id="otherReasonDiv" style="display: none;">
               <label for="otherReason" class="form-label">Please specify</label>
               <textarea class="form-control" id="otherReason" name="otherReason" rows="3"></textarea>
             </div>
           </form>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
           <button type="button" class="btn btn-primary" id="confirmCancelBtn">Confirm Cancellation</button>
         </div>
       </div>
     </div>
   </div>
</main>
<%- include("../../views/partials/user/footer") %>

<script>
function cancelOrder(orderId) {
  console.log("Opening cancel modal for orderId:", orderId);
  document.getElementById('orderIdInput').value = orderId;
  document.getElementById('cancelOrderForm').reset();
  document.getElementById('otherReasonDiv').style.display = 'none';
  const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
  modal.show();
}

document.getElementById('cancelReason').addEventListener('change', function() {
  const otherReasonDiv = document.getElementById('otherReasonDiv');
  otherReasonDiv.style.display = this.value === 'Other' ? 'block' : 'none';
});

document.getElementById('confirmCancelBtn').addEventListener('click', async function() {
  try {
    const orderId = document.getElementById('orderIdInput').value;
    const reasonSelect = document.getElementById('cancelReason');
    const reason = reasonSelect.value;
    
    if (!orderId) {
      throw new Error('Order ID is missing');
    }
    
    if (!reason) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Please select a cancellation reason'
      });
      return;
    }

    const finalReason = reason === 'Other' 
      ? document.getElementById('otherReason').value.trim() 
      : reason;

    if (reason === 'Other' && !finalReason) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Please specify the other reason'
      });
      return;
    }

    console.log("Sending cancel request for orderId:", orderId, "with reason:", finalReason);

    Swal.fire({
      title: 'Cancelling Order...',
      text: 'Please wait while we process your request',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    const response = await fetch('/orders/cancel', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderId: orderId,
        cancellationReason: finalReason
      })
    });

    const data = await response.json();
    console.log("Server response:", data);

    if (data.success) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal'));
      modal.hide();
      Swal.fire({
        icon: 'success',
        title: 'Order Cancelled',
        text: data.message || 'Your order has been cancelled successfully',
        showConfirmButton: false,
        timer: 1500
      }).then(() => {
        window.location.reload();
      });
    } else {
      throw new Error(data.message || 'Failed to cancel order');
    }
  } catch (error) {
    console.error('Error cancelling order:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: error.message || 'Something went wrong'
    });
  }
});
</script>